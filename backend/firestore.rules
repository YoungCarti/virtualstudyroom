rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -----------------------------
    //  USERS
    // -----------------------------
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // -----------------------------
    //  CLASSES (General Access)
    // -----------------------------
    match /classes/{classId} {

      // Read for any authenticated user
      allow read: if request.auth != null;

      // Write only lecturers
      allow write: if isLecturer();

      // -----------------------------
      // CLASS MATERIALS (LECTURER ONLY)
      // -----------------------------
      match /materials/{materialId} {
        // Read for all enrolled users
        allow read: if isEnrolled(classId);

        // Upload only lecturer
        allow write: if isLecturer();
      }

      // -----------------------------
      // ASSIGNMENTS (Lecturer creates)
      // -----------------------------
      match /assignments/{assignmentId} {
        allow read: if isEnrolled(classId);
        allow write: if isLecturer();
      }

      // Submissions (students upload)
      match /assignments/{assignmentId}/submissions/{groupId} {
        // Only group members can submit or view
        allow read, write: if isGroupMember(classId, groupId);
      }

      // -----------------------------
      // GROUPS
      // -----------------------------
      match /groups/{groupId} {

        // Read for group members
        allow read: if isGroupMember(classId, groupId);

        // Write only for lecturer
        allow write: if isLecturer();

        // -----------------------------
        // GROUP MESSAGES
        // -----------------------------
        match /messages/{msgId} {
          allow read, write: if isGroupMember(classId, groupId);
        }

        // -----------------------------
        // VOICE (WebRTC Signaling)
        // -----------------------------
        match /voice/{uid} {
          allow read, write: if isGroupMember(classId, groupId);
        }

        // -----------------------------
        // AI CHAT
        // -----------------------------
        match /aiChat/{msgId} {
          allow read, write: if isGroupMember(classId, groupId);
        }
      }
    }

    // FUNCTIONS
    function isLecturer() {
      return request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "lecturer";
    }

    function isEnrolled(classId) {
      return request.auth != null &&
        classId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.enrolledClasses;
    }

    function isGroupMember(classId, groupId) {
      return request.auth != null &&
        request.auth.uid in get(/databases/$(database)/documents/classes/$(classId)/groups/$(groupId)).data.members;
    }
  }
}
